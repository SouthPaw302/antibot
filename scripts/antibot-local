#!/usr/bin/env bash
set -euo pipefail

# AntiBot local launcher: starts Ollama, gateway, and opens dashboard.
# Works without internet (dashboard + Ollama). Telegram needs network.
# Run from WSL with Node 22 (nvm use 22). Ensures Node >=22.12 via antibot-env.sh.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ANTIBOT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
# Ensure Node 22 in this shell (required for gateway)
if [[ -f "$SCRIPT_DIR/antibot-env.sh" ]]; then
  # shellcheck source=antibot-env.sh
  . "$SCRIPT_DIR/antibot-env.sh"
fi
URL="http://127.0.0.1:18889/"

# Start Ollama if not responding
if command -v ollama >/dev/null 2>&1; then
  if ! curl -fsS --max-time 1 http://127.0.0.1:11434/api/tags >/dev/null 2>&1; then
    (nohup ollama serve >/tmp/ollama-serve.log 2>&1 &) || true
    sleep 0.5
  fi
fi

# Ensure local gateway config exists so we don't need --allow-unconfigured
export ANTIBOT_STATE_DIR="${ANTIBOT_STATE_DIR:-$HOME/.antibot}"
mkdir -p "$ANTIBOT_STATE_DIR"
CONFIG_FILE="$ANTIBOT_STATE_DIR/antibot.json"
if [[ ! -f "$CONFIG_FILE" ]] || ! grep -qE '"mode"\s*:\s*"local"' "$CONFIG_FILE" 2>/dev/null; then
  # Write minimal config (gateway.mode=local required for startup)
  printf '%s\n' '{"gateway":{"mode":"local","bind":"loopback"}}' > "$CONFIG_FILE"
fi

# Start gateway if not already running on 18889
if ! curl -fsS --max-time 1 "$URL" >/dev/null 2>&1; then
  echo "Starting AntiBot gateway..."
  cd "$ANTIBOT_ROOT"
  nohup node antibot.mjs gateway --port 18889 >/tmp/antibot-gateway.log 2>&1 &
  sleep 2
fi

if command -v xdg-open >/dev/null 2>&1; then
  xdg-open "$URL" >/dev/null 2>&1 &
  echo "Opened: $URL"
else
  echo "Open this in a browser: $URL"
fi

echo "Local model (terminal): ollama run lume-llama-unbound"
